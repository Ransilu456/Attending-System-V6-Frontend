var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,l=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,d=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&l(e,s,t[s]);if(a)for(var s of a(t))n.call(t,s)&&l(e,s,t[s]);return e},o=(e,a)=>t(e,s(a)),i=(e,t,s)=>new Promise(((a,r)=>{var n=e=>{try{d(s.next(e))}catch(t){r(t)}},l=e=>{try{d(s.throw(e))}catch(t){r(t)}},d=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,l);d((s=s.apply(e,t)).next())}));import{c,r as u,j as g}from"./vendor-niVxJDCj.js";import{e as m,c as h,B as x,a as p}from"./index-BuwQNYxn.js";import{a as b}from"./index-Cap0JOW1.js";import{J as y,d as f,L as v,Q as w,N as j,V as N,W as k,Y as S,U as A,k as C,q as R,r as P,Z as E}from"./ui-DVJ2orZe.js";const T={MESSAGE_TYPES:{TEXT:"manual",ATTENDANCE:"attendance",NOTIFICATION:"notification",SYSTEM:"system",TEMPLATE:"template",TEST:"test",AUTOMATED:"automated"},formatAttendanceMessage:e=>{const t="entered"===e.status?"Entered School":"left"===e.status?"Left School":"late"===e.status?"Arrived Late":"Marked Present",s=new Date(e.timestamp||e.entryTime).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",hour12:!0,timeZone:"Asia/Colombo"});return`ðŸ« Attendance Update\n  \n  Student: ${e.name}\n  Index Number: ${e.indexNumber}\n  Status: ${t}\n  Time: ${s}\n  \n  Additional Details:\n  Email: ${e.student_email||e.email}\n  Parent Phone: ${e.parent_telephone}\n  Address: ${e.address}`},sendMessage:e=>i(void 0,null,(function*(){var t,s;try{const t=x.loading("Sending message...");if(!e.phoneNumber)throw x.update(t,{render:"Phone number is required",type:"error",isLoading:!1,autoClose:3e3}),new Error("Phone number is required");if(!e.message)throw x.update(t,{render:"Message content is required",type:"error",isLoading:!1,autoClose:3e3}),new Error("Message content is required");const s=e.phoneNumber.replace(/\s+/g,"");s.startsWith("+")||(e.phoneNumber="+"+s);const a=yield h.post("/whatsapp/send",{phoneNumber:e.phoneNumber,message:e.message,type:e.type||"test"});return x.update(t,{render:`Message sent successfully to ${e.phoneNumber}`,type:"success",isLoading:!1,autoClose:3e3}),a.data}catch(a){throw x.update(toastId,{render:(null==(s=null==(t=a.response)?void 0:t.data)?void 0:s.message)||"Failed to send message",type:"error",isLoading:!1,autoClose:3e3}),a}})),sendBulkMessages:e=>i(void 0,null,(function*(){try{const t=x.loading("Sending bulk messages..."),s=yield h.post("/whatsapp/bulk",{studentIds:e.studentIds,message:e.message,type:"notification"}),{summary:a}=s.data;return x.update(t,{render:`Messages sent: ${a.successful} successful, ${a.failed} failed`,type:0===a.failed?"success":"warning",isLoading:!1,autoClose:5e3}),s.data}catch(t){throw x.error("Failed to send bulk messages"),t}})),getWhatsAppStatus:()=>i(void 0,null,(function*(){var e;try{const t=yield h.get("/whatsapp/status");return(null==(e=t.data)?void 0:e.status)?{isReady:t.data.status.isReady,error:t.data.status.error,qrCode:t.data.status.qrCode,connectionEvents:t.data.status.connectionEvents||[],messageStats:t.data.status.messageStats||{total:0,successful:0,failed:0,pending:0},connectionDuration:t.data.status.connectionDuration,serverTime:t.data.status.serverTime}:{isReady:!1,error:null}}catch(t){throw t}})),getQRCode:()=>i(void 0,null,(function*(){try{return(yield h.get("/whatsapp/qr")).data}catch(e){throw e}})),refreshQRCode:()=>i(void 0,null,(function*(){try{if(!(yield checkServerConnectivity()))throw new Error("Server is not responding. Please check if the server is running.");yield new Promise((e=>setTimeout(e,500)));return(yield h.post("/whatsapp/qr/refresh")).data}catch(e){if("Server connection failed"===e.message)throw new Error("Cannot connect to server. Please check if the server is running.");if(e.response&&404===e.response.status)throw new Error("QR refresh endpoint not found. Please check server configuration.");if(e.response&&500===e.response.status)throw new Error("Server error while refreshing QR code. Please try again later.");throw e}})),logoutWhatsApp:()=>i(void 0,null,(function*(){try{return(yield h.post("/whatsapp/logout")).data}catch(e){throw e}})),checkPreviousDayAttendance(){return i(this,null,(function*(){return(yield axiosInstance.post("/api/whatsapp/check-previous")).data}))},getStudentsForMessaging:(e="",t=1,s=50)=>i(void 0,null,(function*(){try{return(yield m.get(`${API_URL}/whatsapp/students`,{params:{search:e,page:t,limit:s},headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")||sessionStorage.getItem("token")}`}})).data}catch(a){throw a}})),sendMessageToStudent:(e,t,s="notification")=>i(void 0,null,(function*(){try{return(yield m.post(`${API_URL}/whatsapp/send-to-student`,{studentId:e,message:t,type:s},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")||sessionStorage.getItem("token")}`}})).data}catch(a){throw a}}))},L=()=>{const{isAuthenticated:e,isAdmin:t}=p(),s=c(),[a,r]=u.useState({isReady:!1,error:null}),[n,l]=u.useState(null),[m,h]=u.useState(!0),[L,I]=u.useState(""),[M,W]=u.useState(""),[D,O]=u.useState(0),[Q,$]=u.useState([]),[q,F]=u.useState({total:0,successful:0,failed:0,pending:0}),[_,U]=u.useState(!1),[Y,H]=u.useState({autoReconnect:!0,notifyOnDisconnect:!0,reconnectAttempts:3,sessionTimeout:24});u.useEffect((()=>{if(!e)return void s("/login",{state:{from:"/whatsapp"}});if(!t)return void s("/");const a=()=>i(void 0,null,(function*(){try{const e=yield T.getWhatsAppStatus();r(e),!e.isReady&&e.qrCode&&l(e.qrCode)}catch(e){x.error("Failed to check WhatsApp status. Please try again later.")}finally{h(!1)}}));a();const n=setInterval(a,1e4);return()=>clearInterval(n)}),[e,t,s]),u.useEffect((()=>{a.isReady&&$((e=>[{timestamp:new Date,event:"Connected",status:"success"},...e]))}),[a.isReady]);const z=()=>i(void 0,null,(function*(){try{h(!0);const e=x.loading("Refreshing QR code..."),t=yield T.refreshQRCode();t.qrCode?(l(t.qrCode),x.update(e,{render:"QR code refreshed successfully. Scan with WhatsApp to connect.",type:"success",isLoading:!1,autoClose:3e3})):x.update(e,{render:"No QR code received. Please try again.",type:"warning",isLoading:!1,autoClose:3e3})}catch(e){x.error(e.message||"Failed to refresh QR code. Please try again.")}finally{h(!1)}}));return u.useEffect((()=>{let e;return n&&(e=setTimeout((()=>{l(null),x.info("QR code expired. Please refresh to get a new one.")}),6e4)),()=>clearTimeout(e)}),[n]),m?g.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:g.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})}):g.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-8",children:[g.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2",children:[g.jsxs("div",{className:"flex items-center gap-3",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(y,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"})}),g.jsxs("div",{children:[g.jsx("h1",{className:"text-2xl font-bold dark:text-white",children:"WhatsApp Integration"}),g.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm mt-1",children:"Manage your WhatsApp connection and messaging settings"})]})]}),g.jsxs("div",{className:"flex items-center gap-3",children:[g.jsx("button",{onClick:()=>U(!_),className:"p-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white bg-gray-100 dark:bg-slate-700 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors",title:"Settings",children:g.jsx(f,{className:"w-5 h-5"})}),a.isReady&&g.jsxs("button",{onClick:()=>i(void 0,null,(function*(){try{const e=x.loading("Logging out from WhatsApp...");yield T.logoutWhatsApp(),x.update(e,{render:"Successfully logged out from WhatsApp",type:"success",isLoading:!1,autoClose:3e3}),r({isReady:!1,error:null}),l(null),$((e=>[{timestamp:new Date,event:"Logged Out",status:"warning"},...e]))}catch(e){x.error("Failed to logout from WhatsApp. Please try again.")}})),className:"flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[g.jsx(v,{className:"w-5 h-5 mr-2"}),"Disconnect"]})]})]}),g.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[g.jsxs("div",{className:"space-y-8",children:[g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(w,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Connection Status"})]}),g.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg",children:[g.jsxs("div",{className:"flex items-center gap-3",children:[g.jsx("div",{className:"h-3 w-3 rounded-full "+(a.isReady?"bg-green-500":"bg-red-500")}),g.jsx("span",{className:"dark:text-gray-200 font-medium",children:a.isReady?"Connected":"Disconnected"})]}),!a.isReady&&g.jsxs("button",{onClick:z,className:"flex items-center px-3 py-1.5 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-md hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors",children:[g.jsx(j,{className:"w-4 h-4 mr-1"}),"Refresh QR"]})]}),a.error&&g.jsx("p",{className:"mt-3 text-red-500 text-sm",children:a.error})]}),!a.isReady&&g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(w,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Scan QR Code"})]}),g.jsxs("div",{className:"flex flex-col items-center",children:[n?g.jsx("div",{className:"p-4 bg-white dark:bg-white rounded-lg shadow-sm",children:g.jsx(b,{value:n,size:256,level:"H",includeMargin:!0},D)}):g.jsx("div",{className:"flex items-center justify-center w-64 h-64 bg-gray-100 dark:bg-slate-700 rounded-lg",children:g.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})}),g.jsxs("div",{className:"mt-4 text-center",children:[g.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Open WhatsApp on your phone and scan this QR code to connect"}),g.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 mt-1",children:"QR code expires in 1 minute"})]})]})]}),g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(N,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Connection History"})]}),g.jsx("div",{className:"max-h-60 overflow-y-auto rounded-lg border border-gray-100 dark:border-slate-700",children:Q.length>0?Q.map(((e,t)=>g.jsxs("div",{className:"flex items-center justify-between p-3 "+(t!==Q.length-1?"border-b dark:border-slate-700":""),children:[g.jsxs("div",{className:"flex items-center",children:[g.jsx("span",{className:"h-2 w-2 rounded-full mr-3 "+("success"===e.status?"bg-green-500":"warning"===e.status?"bg-yellow-500":"bg-red-500")}),g.jsx("span",{className:"dark:text-gray-300",children:e.event})]}),g.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:new Date(e.timestamp).toLocaleString()})]},t))):g.jsx("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:"No connection history available"})})]})]}),g.jsxs("div",{className:"space-y-8",children:[a.isReady&&g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(k,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Send Test Message"})]}),g.jsxs("div",{className:"space-y-4",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Phone Number"}),g.jsxs("div",{className:"flex",children:[g.jsx("span",{className:"inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-slate-700 text-gray-500 dark:text-gray-400",children:g.jsx(S,{className:"h-5 w-5"})}),g.jsx("input",{type:"text",value:L,onChange:e=>I(e.target.value),placeholder:"Enter phone number with country code",className:"flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md border dark:bg-slate-700 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500"})]})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Message"}),g.jsx("textarea",{value:M,onChange:e=>W(e.target.value),rows:3,className:"block w-full px-3 py-2 border rounded-md dark:bg-slate-700 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter your test message"})]}),g.jsxs("button",{onClick:()=>i(void 0,null,(function*(){if(!L||!M)return void x.error("Please enter both number and message");const e=x.loading("Sending message...");try{const t=yield T.sendMessage({phoneNumber:L,message:M,type:"test"});if(t.success)W(""),F((e=>o(d({},e),{total:e.total+1,successful:e.successful+1}))),x.update(e,{render:`Message sent successfully to ${L}`,type:x.TYPE.SUCCESS,isLoading:!1,autoClose:3e3});else{let s=t.message||"Failed to send message";"CLIENT_NOT_READY"===t.code?(s="WhatsApp client not ready. Please scan QR code to connect.",r({isReady:!1,error:s})):"AUTH_LOST"===t.code||"INVALID_WID"===t.code?(s="WhatsApp client needs re-authentication. Please scan QR code again.",r({isReady:!1,error:s}),l(null),z()):"INVALID_PHONE"===t.code&&(s="Invalid phone number format. Please check and try again."),x.update(e,{render:s,type:"error",isLoading:!1,autoClose:5e3}),F((e=>o(d({},e),{total:e.total+1,failed:e.failed+1})))}}catch(t){F((e=>o(d({},e),{total:e.total+1,failed:e.failed+1}))),x.update(e,{render:t.message||"Failed to send message. Please try again.",type:"error",isLoading:!1,autoClose:5e3})}})),className:"w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[g.jsx(k,{className:"w-5 h-5 mr-2"}),"Send Test Message"]})]})]}),g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(y,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Message Statistics"})]}),g.jsx("div",{className:"grid grid-cols-2 gap-4",children:[{label:"Total Messages",value:q.total,icon:A,color:"text-blue-500 dark:text-blue-400"},{label:"Successful",value:q.successful,icon:C,color:"text-green-500 dark:text-green-400"},{label:"Failed",value:q.failed,icon:R,color:"text-red-500 dark:text-red-400"},{label:"Pending",value:q.pending,icon:P,color:"text-yellow-500 dark:text-yellow-400"}].map(((e,t)=>g.jsxs("div",{className:"bg-gray-50 dark:bg-slate-700/50 p-4 rounded-lg border border-gray-100 dark:border-slate-600",children:[g.jsxs("div",{className:"flex items-center justify-between",children:[g.jsx(e.icon,{className:`w-5 h-5 ${e.color}`}),g.jsx("span",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:e.value})]}),g.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:e.label})]},t)))})]}),_&&g.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-slate-700",children:[g.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[g.jsx("div",{className:"bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg",children:g.jsx(f,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),g.jsx("h2",{className:"text-lg font-semibold dark:text-white",children:"Settings"})]}),g.jsx("div",{className:"space-y-4",children:g.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg border border-gray-100 dark:border-slate-600",children:[g.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Emergency Actions"}),g.jsxs("button",{onClick:()=>i(void 0,null,(function*(){if(window.confirm("Are you sure you want to force logout? This will clear all WhatsApp sessions."))try{const e=x.loading("Performing emergency logout...");yield T.logoutWhatsApp(),x.update(e,{render:"Emergency logout successful. All WhatsApp sessions have been cleared.",type:"success",isLoading:!1,autoClose:3e3}),r({isReady:!1,error:null}),l(null),$((e=>[{timestamp:new Date,event:"Emergency Logout",status:"warning"},...e]))}catch(e){x.error("Emergency logout failed. Please try again or contact support.")}})),className:"w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[g.jsx(E,{className:"w-5 h-5 mr-2"}),"Emergency Logout"]})]})})]})]})]})]})};export{L as default};
